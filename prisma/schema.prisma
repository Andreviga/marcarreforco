generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ALUNO
  PROFESSOR
  ADMIN
}

enum Modality {
  PRESENCIAL
  ONLINE
}

enum SessionStatus {
  ATIVA
  CANCELADA
}

enum EnrollmentStatus {
  AGENDADO
  DESMARCADO
}

enum AttendanceStatus {
  PRESENTE
  AUSENTE
  ATRASADO
}

enum InvoiceStatus {
  ABERTA
  EMITIDA
  PAGA
}

enum PackageBillingType {
  PACKAGE
  SUBSCRIPTION
}

enum PackageBillingCycle {
  MONTHLY
  WEEKLY
}

enum PaymentStatus {
  PENDING
  CONFIRMED
  OVERDUE
  CANCELED
  REFUNDED
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELED
  OVERDUE
}

enum CreditReason {
  PAYMENT_CREDIT
  ENROLL_RESERVE
  ENROLL_RELEASE
  ADMIN_ADJUST
}

enum TicketCategory {
  MELHORIA
  DUVIDA
}

enum TicketStatus {
  ABERTO
  EM_ANDAMENTO
  RESOLVIDO
  FECHADO
}

model User {
  id           String          @id @default(cuid())
  name         String
  email        String          @unique
  passwordHash String
  role         Role
  createdAt    DateTime        @default(now())

  studentProfile StudentProfile?
  teacherProfile TeacherProfile?

  enrollments   Enrollment[]   @relation("StudentEnrollments")
  attendances   Attendance[]   @relation("MarkedAttendances")
  studentAttendances Attendance[] @relation("StudentAttendances")
  sessions      Session[]      @relation("TeacherSessions")
  invoices      Invoice[]      @relation("StudentInvoices")
  auditLogs     AuditLog[]     @relation("ActorAuditLogs")
  passwordResetTokens PasswordResetToken[]
  createdTickets Ticket[]      @relation("CreatedTickets")
  studentTickets Ticket[]      @relation("StudentTickets")
  teacherTickets Ticket[]      @relation("TeacherTickets")
  ticketMessages TicketMessage[] @relation("TicketMessages")

  asaasCustomer AsaasCustomer?
  asaasSubscriptions AsaasSubscription[]
  asaasPayments AsaasPayment[]
  creditBalances StudentCreditBalance[] @relation("StudentCredits")
  creditLedger StudentCreditLedger[] @relation("StudentCreditLedger")
  creditLots StudentCreditLot[] @relation("StudentCreditLots")
}

model StudentProfile {
  userId  String @id
  serie   String
  turma   String
  unidade String
  responsavel String?
  document String?

  user User @relation(fields: [userId], references: [id])
}

model TeacherProfile {
  userId String @id

  user     User             @relation(fields: [userId], references: [id])
  subjects TeacherSubject[]
}

model Subject {
  id     String          @id @default(cuid())
  name   String          @unique
  defaultPriceCents Int  @default(0)
  eligibleTurmas String[] @default([])
  eligibleSeries String[] @default([])
  teachers TeacherSubject[]
  sessions Session[]
  packages SessionPackage[]
  creditBalances StudentCreditBalance[]
  creditLedger StudentCreditLedger[]
  creditLots StudentCreditLot[]
  createdAt DateTime @default(now())
}

model SessionPackage {
  id           String   @id @default(cuid())
  name         String
  sessionCount Int
  priceCents   Int
  active       Boolean  @default(true)
  billingType  PackageBillingType @default(PACKAGE)
  billingCycle PackageBillingCycle?
  subjectId    String?
  createdAt    DateTime @default(now())

  subject      Subject? @relation(fields: [subjectId], references: [id])
  subscriptions AsaasSubscription[]
  payments     AsaasPayment[]

  @@unique([name])
}

model TeacherSubject {
  teacherId String
  subjectId String

  teacher TeacherProfile @relation(fields: [teacherId], references: [userId])
  subject Subject        @relation(fields: [subjectId], references: [id])

  @@id([teacherId, subjectId])
}

model Session {
  id         String        @id @default(cuid())
  subjectId  String
  teacherId  String
  startsAt   DateTime
  endsAt     DateTime
  location   String
  modality   Modality
  priceCents Int
  status     SessionStatus @default(ATIVA)
  createdAt  DateTime      @default(now())

  subject    Subject       @relation(fields: [subjectId], references: [id])
  teacher    User          @relation("TeacherSessions", fields: [teacherId], references: [id])
  enrollments Enrollment[]
  attendances Attendance[]
  invoiceItems InvoiceItem[]
}

model Enrollment {
  id         String           @id @default(cuid())
  sessionId  String
  studentId  String
  status     EnrollmentStatus @default(AGENDADO)
  creditsReserved Int          @default(0)
  createdAt  DateTime         @default(now())

  session   Session @relation(fields: [sessionId], references: [id])
  student   User    @relation("StudentEnrollments", fields: [studentId], references: [id])
  attendance Attendance?
  creditLedger StudentCreditLedger[]

  @@unique([sessionId, studentId])
}

model Attendance {
  id            String           @id @default(cuid())
  sessionId     String
  studentId     String
  enrollmentId  String           @unique
  status        AttendanceStatus
  note          String?
  markedByUserId String
  markedAt      DateTime         @default(now())

  session   Session  @relation(fields: [sessionId], references: [id])
  student   User     @relation("StudentAttendances", fields: [studentId], references: [id])
  enrollment Enrollment @relation(fields: [enrollmentId], references: [id])
  markedBy  User     @relation("MarkedAttendances", fields: [markedByUserId], references: [id])
  invoiceItems InvoiceItem[]

  @@unique([sessionId, studentId])
}

model Invoice {
  id         String        @id @default(cuid())
  studentId  String
  month      Int
  year       Int
  status     InvoiceStatus @default(ABERTA)
  totalCents Int
  createdAt  DateTime      @default(now())

  student User         @relation("StudentInvoices", fields: [studentId], references: [id])
  items   InvoiceItem[]

  @@unique([studentId, month, year])
}

model InvoiceItem {
  id           String @id @default(cuid())
  invoiceId    String
  sessionId    String
  attendanceId String
  description  String
  occurredAt   DateTime
  amountCents  Int

  invoice    Invoice   @relation(fields: [invoiceId], references: [id])
  session    Session   @relation(fields: [sessionId], references: [id])
  attendance Attendance @relation(fields: [attendanceId], references: [id])
}

model AsaasCustomer {
  id        String   @id @default(cuid())
  userId    String   @unique
  asaasId   String   @unique
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model AsaasSubscription {
  id          String             @id @default(cuid())
  userId      String
  packageId   String
  asaasId     String             @unique
  status      SubscriptionStatus
  nextDueDate DateTime?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  user       User           @relation(fields: [userId], references: [id])
  package    SessionPackage @relation(fields: [packageId], references: [id])
  payments   AsaasPayment[]
}

model AsaasPayment {
  id             String        @id @default(cuid())
  userId         String
  packageId      String
  subscriptionId String?
  asaasId        String        @unique
  status         PaymentStatus
  amountCents    Int
  billingType    String
  dueDate        DateTime?
  paidAt         DateTime?
  payload        Json?
  createdAt      DateTime      @default(now())

  user         User             @relation(fields: [userId], references: [id])
  package      SessionPackage   @relation(fields: [packageId], references: [id])
  subscription AsaasSubscription? @relation(fields: [subscriptionId], references: [id])
  creditLedger StudentCreditLedger[]
  creditLots StudentCreditLot[]
}

model StudentCreditBalance {
  id        String   @id @default(cuid())
  studentId String
  subjectId String
  balance   Int      @default(0)
  updatedAt DateTime @updatedAt

  student User    @relation("StudentCredits", fields: [studentId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])

  @@unique([studentId, subjectId])
}

model StudentCreditLot {
  id        String   @id @default(cuid())
  studentId String
  subjectId String
  paymentId String?
  total     Int
  remaining Int
  expiresAt DateTime
  createdAt DateTime @default(now())

  student User @relation("StudentCreditLots", fields: [studentId], references: [id])
  subject Subject @relation(fields: [subjectId], references: [id])
  payment AsaasPayment? @relation(fields: [paymentId], references: [id])
  ledgerEntries StudentCreditLedger[]

  @@index([studentId, subjectId])
  @@index([expiresAt])
}

model StudentCreditLedger {
  id           String       @id @default(cuid())
  studentId    String
  subjectId    String
  delta        Int
  reason       CreditReason
  enrollmentId String?
  paymentId    String?
  creditLotId  String?
  createdAt    DateTime     @default(now())

  student    User           @relation("StudentCreditLedger", fields: [studentId], references: [id])
  subject    Subject        @relation(fields: [subjectId], references: [id])
  enrollment Enrollment?    @relation(fields: [enrollmentId], references: [id])
  payment    AsaasPayment?  @relation(fields: [paymentId], references: [id])
  creditLot  StudentCreditLot? @relation(fields: [creditLotId], references: [id])

  @@index([studentId, subjectId])
}

model Ticket {
  id          String         @id @default(cuid())
  title       String
  description String
  category    TicketCategory
  status      TicketStatus   @default(ABERTO)
  createdById String
  studentId   String
  teacherId   String
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  createdBy User @relation("CreatedTickets", fields: [createdById], references: [id])
  student   User @relation("StudentTickets", fields: [studentId], references: [id])
  teacher   User @relation("TeacherTickets", fields: [teacherId], references: [id])
  messages  TicketMessage[]

  @@index([status])
  @@index([studentId])
  @@index([teacherId])
}

model TicketMessage {
  id        String   @id @default(cuid())
  ticketId  String
  authorId  String
  message   String
  createdAt DateTime @default(now())

  ticket Ticket @relation(fields: [ticketId], references: [id])
  author User   @relation("TicketMessages", fields: [authorId], references: [id])

  @@index([ticketId])
}

model AuditLog {
  id          String   @id @default(cuid())
  actorUserId String
  action      String
  entityType  String
  entityId    String
  payloadJson Json
  createdAt   DateTime @default(now())

  actor User @relation("ActorAuditLogs", fields: [actorUserId], references: [id])
}

model AdminBootstrapToken {
  id          String   @id @default(cuid())
  email       String
  tokenHash   String
  expiresAt   DateTime
  usedAt      DateTime?
  createdAt   DateTime @default(now())

  @@index([email])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  tokenHash String
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}
